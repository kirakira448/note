## 引言

我们前面学习了类图、活动图、状态机图、顺序图四种UML里的图形，其中类图是用于结构性建模的，它的侧重点在表达系统的结构，系统中有哪些类、相互之间是怎么关联到一起的。

而怎么通过这些类完成整个流程，流程中关键类实体的状态会发生怎样的转换，以及相互之间沟通时会有哪些信息交互则是由被称为流程分析三剑客的活动图、状态机图、顺序图来完成。它们三个各有所长，结合使用才能发挥出最大的功效。

### 类图和流程三剑客适合哪些技术评审

这四种图形掌握后完全可以用它们应对中小型项目、常规迭代需求的流程分析、技术评审之类的工作了，而中小型项目、常规迭代我估计能占到我们工作中任务的80%～90% 因为毕竟从零开始做大项目的机会在公司里其实并不多。

有的常规迭代甚至用不到类图，因为大的类结构一般项目初期已经定型，除非做的项目是增加新的大模块否则系统的结构建模中不涉及到大的改变。

所以本节内容学完后，我们应该能用我们已经学习的UML知识来应对大部分日常研发工作了，至于剩下的那些10% ～ 20% 是应对项目经理、产品经理、架构师的一部分工作才需要掌握的，在后面的课程我们会继续对它们进行学习。

### 技术评审的常见问题

关于这几种UML图形的使用的常用疑问，我这里归了下类。

类图

- 类图和表示数据库表的ER图是对等的吗？
    
- 我们该怎么从数据库表、ER图推演出详细的系统类图？
    
- 类图怎么指导我们写代码？
    

流程三剑客-活动图、状态机、顺序图

- 三剑客各自的特点
    
- 怎么使用三剑客把系统流程分析做的面面俱到
    
- 三剑客怎么指导我们写代码
    

在课程中我会对这些疑问一一解答，由于篇幅问题我把结构建模和行为建模分为了两节，本节我们先来专注结构建模，它的建模过程也是我们了解需求和为项目打好基础的过程。

## 业务结构建模

类图从需求分析到功能实现设计都能起到那种让我们“一目了然”的作用，很多人使用下来会有疑问“类图里的类是不是跟项目数据库里的表是一一对应的呀，数据表里的字段就是类图里的属性，如果是的话我直接设计数据库画ER图还需要类图吗？”

针对这些疑问我可以说**系统业务结构建模里的类图差不多是跟项目用到的数据表是一一对应的(一些例外会后面细讲) ，但是类图有数据表ER图不可替代的作用，它的表达里力强，同时在软件开发适用的阶段也更多能贯穿从需求分析到软件设计实现的大部分过程**。

我一般在接到一个中型以上的项目时才会使用类图，什么叫中型以上的项目呢？

- 首先需要从零开始建设的业务系统，肯定算中型以上的项目
    
- 业务中要引入新的玩法，需要引入新的库表，比如订单要引入优惠卷的玩法，那肯定就需要引入新的数据表新的实体类才能完成
    

那么需要开发中型以上项目的需求给到我后，不谈这个需求是不是合理、公司开发它的战略意义、都有哪些干系人（即这个项目关乎谁的利益）这些需求战略层面上的分析，我们这里只关心怎么用UML做好需求实现。

### 识别业务实体

拿到项目需求后，不管是从零开始建设的还是需要引入新的实体类、数据库表才能搞定的现有业务需求，我都会用类图在纸上大概画出实现业务能想到的、用到的类，当然这个类图往往就是一个方块，也没有具体的类属性，如果两个类有关系的话就用直线把他们连接起来。

比如现在我们有一个需求要给客户开发一个电商系统，拿到这个系统我们需要先分析电商系统一般都需要有哪些实体。

![图片](设计/程序员画图/img/12_程序员怎么做好技术评审--业务结构分析和建模/1.jpg)

### 业务结构建模

有了这些我们就能知道系统里大概有了那些业务实体，这些业务实体往往与项目里的数据表对应，不过我们先不要急着去设计数据表的结构，接下来按照UML开展项目的节奏是要对这些类图进行细化，用类图表示出业务的大体结构

![图片](设计/程序员画图/img/12_程序员怎么做好技术评审--业务结构分析和建模/2.jpg)

这里我们细化类的属性的同时还要识别每个类的角色--哪些是聚合根，这里借鉴了一点DDD里的理念，可以理解为主类，以及主类跟它的附属类还有协作类之间的关系。

就上面这个例子来说，订单显然是一个主类，它和订单明细是聚合的关系--订单不存在也就没有订单明细了，同时它与商品类是依赖的关系--下单这个行为会依赖商品才能完成，类的各种关系都是什么、在代码和UML图里分别怎么表示我们在前两节已经介绍过，如果不明白的请回看：《**[深入浅出｜用代码拆解软件设计中类的六种关系](http://mp.weixin.qq.com/s?__biz=MzUzNTY5MzU2MA==&mid=2247499945&idx=1&sn=502dd4e82ab6e246b472b812d4275ac5&chksm=fa83113ecdf498289fdb721398556adfb2839d19cfe79bef43ec503723ea15d0962621e30963&scene=21#wechat_redirect)》**

**识别主类（聚合根）也是为了后面软件设计进行考虑，上面类图中订单和商品类都是主类，下面引用一些DDD中的知识对聚合根做点介绍，让大家在识别主类时能更清晰一些。**

**聚合根也称为根实体，它不仅是实体，还是聚合的管理者。**如果把聚合比作组织，那聚合根就是这个组织的负责人。

- 首先它作为实体本身，拥有实体的属性和业务行为，实现自身的业务逻辑。
    
- 其次它作为聚合的管理者，在聚合内部负责协调实体和值对象按照固定的业务规则协同完成共同的业务逻辑。（即，所有操作，应该由根实体发起，比如事务内先变更跟实体状态，再更新与他配合的实体）
    

![图片](设计/程序员画图/img/12_程序员怎么做好技术评审--业务结构分析和建模/3.jpg)

- 最后在聚合之间，它还是聚合对外的接口人，以聚合根 ID 关联的方式接受外部任务和请求，在上下文内实现聚合之间的业务协同。也就是说，聚合之间通过聚合根 ID 关联引用，如果需要访问聚合的其他实体，就要先访问聚合根，再导航到聚合内部实体，外部对象不能直接访问聚合内实体。
    
- 上一条可以理解为协作的时候，调用RPC、方法之类的参数应该是根实体的唯一标识，即使修改的是与它关联的附属实体--比如某个订单明细，也应该传根实体的ID--订单ID，让聚合根来在内部协调完成操作，而不是直接通过附属实体的ID对其进行修改。
    

像上面的例子中，**商品类、订单类显然是聚合根的角色，所有涉及到商品的操作都应该通过商品类来完成。换句话说比如上面我们省略了存储商品详情的类GoodsDetailContents 那么假如我们要修改某个商品的详情，这个行为应该是Goods类的行为而不是GoodsDetailContents的行为，GoodsDetailContents这种作为Goods实体附属的类在DDD里被称作值对象，值对象中应该只有Getter 和 Setter之类的行为**。

我们在这个阶段要做好的就是识别出系统业务实体里的聚合根，这样未来做软件设计的时候我们的流程在哪里实现就明确了，无非就是通过聚合根或者是其上层的领域服务层来实现，这个步骤做好了能防止我们编码实现时在项目里出现过多的领域服务，不用每个实体类都设计一个Service出来。

## 业务结构和库表设计的相互转换

看了上面那一大堆分析，肯定会有人说：“这也太麻烦了，哪有那么多时间我们一般都是看看需求直接设计库表了”。

说句实话据我观察身边大部分人的工作习惯是拿到需求后，像一开始那样在纸上画画方块识别一下有哪些业务实体，接下来去按照识别出来的业务实体去设计数据库表。

这里有熟练度的问题，当你对一个东西不熟的时候，把它融入到你日常的工作中时阻力肯定是会比较大的。所以咱们想让UML帮助我们完成工作，就不能完全打破现有的工作习惯里的步骤，如果在你对类图做业务建模不熟悉的时候让你先去细化类图再去设计数据库表，你一定用不起来UML。

所以**咱们还是先按照工作习惯根据识别出来的业务实体把项目用到的数据表设计出来，再来回去考虑业务建模也是可以的，重要的是先用起来，上面使用类图做的业务结构建模其实就是把你在纸上写写画画的东西用一个更标准、其他人都能看懂的方式表达出来**。

这里就不放数据表的SQL语句了，直接来一张数据表的ER图，一般ER图可以用数据库软件生成，也可以自己用绘图软件画， 用数据库软件生成局限比较大只有表跟表有外键关联才能画出表的关系，我一般是自己画ER图，其中只标一些关键的字段和表的关系。

![图片](设计/程序员画图/img/12_程序员怎么做好技术评审--业务结构分析和建模/4.jpg)

接下来把ER图转换为类图表示的业务结构的时候，注意不要直接把数据表的关系翻译成类的关系，还是要思考一下哪些是主类，哪些是附属类，主类和附属类画成包含的关系（聚合和组合）主类和其他协作类大概率会画成依赖或者关联的关系。

一旦你对UML的使用熟悉后，我还是建议按照先识别类、细化类、类关系、确定有那些聚合（类组）、聚合中谁是根实体谁是附属实体，把大体的细节都想的差不多了再去设计数据表，其实这个过程不存在时间上的浪费的，你梳理好类关系和聚合根这些细节后，表跟表之间怎么关联，谁是模块中的主表谁是附属表就很清楚了。

还有一点要注意，类图中的类和表不见得非得是一一对应的，有的人喜欢使用一些JSON类型的字段来存储值对象，比如我把订单快照做成`JSON`数据存到 `orders` 表中的 `snapshot` 字段中，从数据表层面它是一个表，但是从业务结构建模上最好把他们分成两个类，不然就非常容易定义成一个`String`类型的字段，时间久了别说其他人，就连自己都忘了里面存的数据具体有哪些了。

我是个人设计表的时候不爱使用太多的JSON类型之类的复合字段，但是这个完全看个人喜好，不做过多评价。

## 总结

本节介绍的用类图做的业务结构建模其实就是把项目初期你在纸上写写画画的东西用一个更标准、其他人都能看懂的方式表达出来，这样做技术评审时让就更容易让别人看懂。

与此同时我也推荐还不熟悉使用类图做业务结构建模的同学不必严格按照现有结构建模再设计库表的流程来执行，也可以按照自己的习惯先做库表设计再做业务结构建模，这个过程中发现数据表有需要调整的地方再去调整。 虽然业务结构建模里的类图跟数据表可能是是一一对应的 ，但是类图它的表达力更强，从需求分析到软件设计阶段都能提供很大的参考价值。

现在业务结构有了，他还要能动起来才能变成真正的业务，下节课我们讲怎么使用活动图、顺序图、状态机图从不同的角度分析业务的流程。