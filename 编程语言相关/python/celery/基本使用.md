模板
## 0.初始化准备

## 搭建环境

```bash
pip install celery
pip install redis
```

本示例中使用版本：
```text
celery-5.4.0
redis-5.0.4
```


### 开启消息中间件

这里使用redis作为消息中间件
使用docker的形式开启redis


## 1. 创建`celery_task`（定义任务）
在这里定义*任务*是什么
`celery_task.py`
```python
from celery import Celery
import time

# 创建Celery对象
# broker:消息中间件地址
# backend:结果存储地址
app=Celery('tasks',broker='redis://192.168.3.3:6379/5',backend='redis://192.168.3.3:6379/6')


# 定义任务函数
@app.task           # 任务装饰器，将函数注册为celery任务
def send_email(name):
    print(f'准备发送{name}的邮件')
    time.sleep(5)
    print(f'{name}的邮件发送成功')

@app.task
def send_msg(name):
    print(f'准备发送{name}的短信')
    time.sleep(5)
    print(f'{name}的短信发送成功')
```

## 2. 启动work

``` bash
celery -A 可执行的任务文件 worker --loglevel=INFO --concurrency=并发的数量
```

这里使用如下命令：
```bash
celery -A celery_task worker --loglevel=INFO
```

>**注意**
>windows平台，可能会报错，也可能不报错，但不执行任务
>
>**解决方案**
>指定要执行的工具eventlet
```bash
pip install eventlet==0.36.1
```
>启动命令改为
```bash
celery -A 可执行的任务文件 worker --loglevel=INFO --concurrency=并发的数量 -P eventlet
```

```bash
celery -A celery_task worker --loglevel=INFO --concurrency=3 -P eventlet
```
## 3. 创建`product_task`（发布任务）
在这里*发布任务*

`product_task.py`
```python
from celery_task import send_email,send_msg


def delay_task():
    '''
    发送异步任务
    '''
    rs1=send_email.delay('zhangsan')
    rs2=send_msg.delay('ZS')
    print(rs1.id)
    print(rs2.id)

if __name__=="__main__":
    delay_task()
```

## 4. 执行
运行`product_task.py`后，可以在**步骤2**中的celery的控制台看到任务执行日志

## 5.创建`result.py`（获取结果）
任务执行后需要*获取结果*

`result.py`
```python
from celery.result import AsyncResult
from celery_task import app

# 创建获取结果的对象
# id就是product_task中的rs.id
result=AsyncResult(id='1195cb5b-8af7-4180-84ea-2c58f376af1d',app=app)

# 获取结果
if result.successful():
    print(result.get())
elif result.failed():
    print('任务执行失败')
elif result.status== 'PENDING':
    print('任务等待中')
elif result.status== 'RETRY':
    print('任务重试中')
elif result.status== 'STARTED':
    print('任务开始执行')
```

## 6. 任务监控台

```bash
pip install flower
```

启动`flower`
```bash
celery -A celery_task flower --port=5555
```

- -A：项目名
- --port：端口号

通过 `http://localhost:port`访问flower

# 基本方法

## 异步任务调用

### delay( )方法

在标记为任务的方法后面直接加上`.delay()`，表示使用异步任务
```python
from celery_task import *


def delay():
  rs = send_email.delay('baizhan')
  print(rs.id)


  rs2 = send_msg.delay('SXT')
  print(rs2.id)
```

## 定时任务调用

### apply_async( )方法

在标记为任务的方法后面直接加上`.apply_async()`，表示使用定时任务
```python
from celery_task import *
import datetime


def time_exec():
  # 获取当前时间
  c_time = datetime.datetime.now()
  # 获取当前时间的utc时间
  utc_time = datetime.datetime.utcfromtimestamp(c_time.timestamp())
  # 设置定时任务的执行时间
  s5 = datetime.timedelta(seconds=5)
  # 获取定时任务的执行时间
  exec_time = utc_time + s5


  rs = send_email.apply_async(args=['baizhan'],eta=exec_time)
  print(rs.id)
  rs2 = send_msg.apply_async(args=['SXT'],eta=exec_time)
  print(rs2.id)
```


## 钩子函数（hook）

