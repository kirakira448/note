凡是写过代码的小伙伴一定经历过接手的项目里业务核心一大堆状态位，MySQL里字段上的注释、程序里的枚举一大堆。但是状态的变更都是在什么时候发生的，状态间是怎么流转下去的可能组里的老大哥也不能完全把每个细节说清楚，让你自己看代码慢慢抠。那么**本章我们要学的状态机--它对状态的管理和标记能在很大程度上缓解研发团队里这种尴尬的现状**。

本篇文章我们来继续学习用UML做需求分析和技术评审时经常会用到的另一个流程分析利器 -- 状态机图，英文术语叫做State Machine Diagram，在中文资料里一般会把它翻译成状态机图或者是状态图，大家知道这俩是一个东西就行，没必要那么较真儿到底哪种称呼才对。

## 认识状态机图

我们先来快速看一下状态机图长什么样子。

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/1.jpg)

怎么样，是不是跟我们上一节学到的活动图很像，但是又有点不一样呢？这张状态机图表示的是我们上一节在案例演示中的员工请假流程中“请假申请”这个“物件”的所有状态和相应的流转过程。

这里我们再把表达请假审批业务流程的活动图拿来对比一下：

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/2.jpg)

乍一看上去，状态机图与活动图很类似，实际上这两种图分别对应于两种不同的分析角度和分析阶段。活动图可以说是流程分析的万能图，什么流程都可以用活动图来表达，也是我们刚接触到业务需求后会先用到的工具。

设想一下在接到一个业务需求后，我们要做的是不是先把整体流程捋出来？捋出来之后呢？如果流程中涉及到某个核心业务实体的状态变更，那么接下来我们最好从以下几个方面来分析它的状态：

- 它都有哪些状态？（对应数据表里的可能的状态枚举）
    
- 这些状态里谁是初始态、谁是中间态、谁是最终态 ？（思考用什么技术方案保证流程结束后保证业务实体处在最终态，而不是卡在中间态，减少人工处理BUG的场景）
    
- 这些状态在整个业务流程中的哪些时机发生转换的？（理清代码里都有哪些要Update状态的逻辑）
    

上面三个问题中，我都在括号标注了为什么要考虑这些的原因，那么有没有一种工具让我们在需求分析和技术方案时能把这些东西直观的表达出来，再指导我们开发实现的呢？状态机图就是UML这个工具箱里专门让我们用来做这个事情的，所以以后一旦我们想要**分析流程是如何围绕着其业务核心实体的状态展开的，应该首选状态机图**。

那么接下来本节就来从语法到案例讲解再到实践练习全面地学习状态机图，**此外我们还会在课程后半部分给到两个企业级项目的状态机图给大家参考，大家一定不要错过**。

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/3.jpg)



## 从活动图转换到状态机图

我们上面说过，做需求分析或者技术方案时应该先捋出需求的整个大的流程，这个流程使用活动图来表达，回到上面展示了请假审批这个流程的活动图中，**活动图是将流程分解成了一个一个的活动（步骤），通过活动的先后顺序来展示流程是怎么开展的；**

相信大家都用自己公司的OA系统请过假，提交请假后会走一个审批流，根据你请假的天数和类别（年假、调休、婚假等）在这个流程里会由不同职能的同事对你提交的请假申请进行审批，但基本流程肯定是你的直线主管、隔级主管、业务VP来审批。

啥意思呢？就是你提交了请假后，你的组长要审批、审批完了后是管你组长的部门老大来批，如果请假的天数超过3天（假设）还得最终让负责你们的VP来批，如果你是技术就是CTO给你最后批，是业务运营就是COO给你最终审批。为啥这样呢？可能是不想让你休太长的假？......聊跑偏了，继续咱们的学习。

通过上面的分析我们大概能知道，“请假申请”这个业务实体大概会有这些状态：

首先是创建请假申请--**已创建**、信息填完后你点提交--**已提交**、让你的直级领导审批--**部门经理审批**（组长不如这个好听，这里就叫部门经理吧）、**副总经理审批**、如果你的请假是一两天的假，到这里审批就通过了（变成**已批准**），否则的话还得让**总经理审批**通过后这个假才能请下来。

> 上面黑色加粗文字就是我们在流程中捋出来的状态，除了这些还应该有已拒绝待修改和已撤销这几个申请被拒绝条件下的状态

**状态机图是就从某个事物的状态是如何变化的角度来展示流程的**。上述请假申请-审批流程用状态机图表达，就是我们前面一开始举例中使用的状态机图的样子，我把这张图拿到这里大家结合着我上面的分析再来认真地读一下这个状态机图

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/1.jpg)

这个图里我们还展示了，假如领导不给你批假状态会怎么变更。

所以从分析大流程的活动图细化到分析核心事物状态的状态机图

- 首先我们要考虑的是，请假流程是围绕着什么“事物”展开的？--- 没错，请假申请！请假申请的载体可以是纸质的申请表，也可以是考勤系统里的电子记录，这些都无所谓
    
- 确定了流程围绕着什么“事物”展开后，接下来我们要考虑的是这个“事物”--- 请假申请，从流程的开始后到最终结束都会经历什么状态呢？
    
- 状态之间是如何变化的？是什么操作导致了这个状态变化？
    

这就是状态机图要表达给读者的内容，也是从大流程细化到具体的核心事物状态机的步骤。

## 状态机图的语法

接下来我们来详细学习一下状态机图的语法。

### 开始/结束状态

类似于活动图，每个状态机图都有一个开始状态、一个或多个结束状态。

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/5.jpg)

一个圆角矩形框代表一个实际的状态。

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/6.jpg)

这个框框与活动图的框很类似，他们的区别是活动图里一个框代表流程里的一个步骤，里面的文字表达的是做什么事情，而状态机图里每个圆角矩形框中的文字表达的是处在的某种状态。

### 状态转换

状态与状态之间的箭头叫做“转换”，注意箭头的画法不要画错了。

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/7.jpg)

箭头上的文字说明了什么事情导致了状态发生变化。说明文字要带上主语：xxx 做了什么事情 。比如上面这个初审员审核通过后，申请的状态从已提交转换到了已初审，

### 初始态和最终态

开始状态符号指向的状态即为流程中业务实体的初始状态，而指向结束状态符号的状态则为实体的最终态，比如上面示例的请假申请状态机图中“已提交”为初始状态，“已批准”和“已撤销”为终态，其他的就是业务实体的中间态。

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/8.jpg)

### 分支条件

上面学习的语法都比较简单和基础，表达的审批流程也只有一级审批，实际上日常的流程很多都比这个复杂，需要有判断条件，不同条件走不同的流程。比如我们文中演示的请假流程中-请假申请的状态机图，部门经理批准申请后副总经理可以批追也可以拒绝这个请假申请，而且如果请假的时间大于3天副总审批后还需要总经理审批，从这里我们至少能找出两个需要分支结构的地方：

- 审批通过和审批拒绝
    
- 请假天数小于3天还是大于3天
    

我们看下这种分支结构在状态机图里应该怎么表示

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/9.jpg)

当某个状态有两个或两个以上指出的箭头时，表示这里有分支结构。上面我们分析出来的流程中，有状态变化的两个分支我都在图中用红字标注了出来。

状态机图表示分支结构的方式就是通过多个转换来表示的，转换还可以加上守护（Guard）就是上图中写在"[]" 中的文字，表示这个转化发生应该具备的条件（比如: [请假时间 > 3天]），这个守护活动图里也有，用法类似。

## 使用状态机的常见问题

### 问题一：如何克服活动图的思维习惯？

从活动图的思维习惯切换到状态机图的思维习惯，是有点难度的，一不小心就会搞错。新手要记住以下几点：

- 流程是围绕什么事物开展的？
    
- 这个事物有怎样的状态？
    
- 当一个状态可以转换为两个或以上状态时，表示这里需要加入分支结构。
    

### 问题二：活动图的泳道非常好用，状态机图可以用泳道吗？

活动图的每一条泳道表示其中的活动都是由泳道到所代表的角色发起。状态机图中圆角矩形框代表的不是活动，而是某个事物的的状态，这个状态是属于该事物的，而不是属于某个角色的。

状态机图中的“活动”，是通过那些带箭头的线条（转换）来体现。所以无法将状态图的转换归类放入泳道，那样更难组织状态图的结构，因此状态机图是完全不同于活动图的一种表达方式，泳道在状态机图中完全不适用。

### 问题三：活动图和状态机图在需求分析时只能选择一个使用吗？

如果活动图是围绕某一事物的状态展开时，可首选状态机图。但不代表状态机图与活动图是互斥的。实际上更建议两种图一起使用：

- 两种图是两种角度，用两种角度来分析问题，更加全面透传。
    

我们在文章开头以研发拿到需求进行需求分析的先后步骤为例给大家举例说明了，活动图是一开始拿到需求后分析整个流程的时候更常用，而一旦确定大流程后要深挖需求里的核心业务实体的时候就会需要用到状态机图以更微观的视角挖掘每个核心业务实体在大流程中的状态变化过程，所以活动图、状态机图两者结合让我们能更有利于我们做好需求分析和技术方案设计。

**我们开发系统正是用代码来实现状态机图里的业务实体状态变更的一个个方法，然后把这些方法按照活动图表达的整体流程串联组织在一起来完成的**。

### 注意事项

状态不能拆的太细，太细了就会对应更多的分支结构--变复杂，思考上面为什么是“拒绝” 而没有拆分出“部门经理拒绝”、“副总经理拒绝”？

仔细看请假这件事，我们能发现无论是审批流里的谁拒绝，申请都得回到待修改的状态，待员工重新编辑申请后再次提交审批。 所以这里就不需要那么多种拒绝了，如果细分状态过多每个情况都意味着要加一个分支结构，这样整个状态的流转就会变得很复杂，编码实现起来也会变复杂。

所以要注意规避这种情况，怎么规避呢？更多的了解业务，结合自己的经验来识别合理的状态。

## 案例参考

这节课我们讲了怎么从拿到需求梳理出流程后，在细化分析出需求业务实体的状态机，全篇用了一个考勤请假的例子讲解了状态机图的绘图语法和使用时人们常会有的疑问以及总结出了一些使用的经验。

在案例参考环节我们在给出两个更复杂的状态机图示例。

第一个是偏中后台系统的一个状态机图，展示的是一个车险理赔系统的核心实体--理赔案件的状态流转。大家可以尝试读一下从用户发起到最终赔付这个过程中状态是怎么流转的。

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/10.jpg)

下面则是一个互联网营销活动运营系统里营销活动的状态机图，这个图例组织活动时，用了包图把不同类别的状态放在了对应的包图中。

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/11.jpg)这个状态机图结合包图的画法是当时合作的一个产品经理在状态机图上的创新，对于业务状态太多的归类展示有些帮助，不过不用刻意去应用，等你对状态机图掌握熟练之后，完全可以依照自己的应用场景在画法上做些微创新--不过宗旨一定是要让人看的更明白，而不是让人眼花缭乱。

## 实战画图教学

状态机图的元素跟活动图使用的元素基本一致，而且在画法上比活动图还简单了一些， 使用的绘图元素无非也是圆角矩形、箭头、开始标记、结束标记这些。

前面活动图相关的章节里我们已经用了一节课专门讲了怎么把复杂流程画成活动图，状态机图无非就是圆角矩形用来表示的是具体的一个状态，箭头则表示状态之间的转换。而且保持活动图布局简洁清楚的几个经验在画状态机图的时候也仍然适用。

前面活动图好好学了，这里的画图实战也一定难不住你，为了进一步降低你的开始难度这里我把本节举的三个例子：考勤请假申请的状态机、保险理赔申请的状态机以及运营营销活动的状态机图都放在了下面这个仓库里。

大家可以在下面这个Github仓库，找到本节案例中使用的三个状态机图的绘图源文件。

- https://github.com/kevinyan815/developer-omni-illustration-tutorial/
    

![图片](设计/程序员画图/img/09_学会理清系统核心的状态机，能少抠不少代码/12.jpg)

实战部分大家就先参考着这些示例尝试从自己的项目里梳理出来一个状态机图吧，就不再单独开一节给大家一步步讲怎么画出来了。

看过上一节活动图的手把手绘图指南后让大家再画状态机图也不会有什么困难。如果后面大家确实有需要可以留言，到时候再单独做状态机图的绘图指南吧。