
**参与者:**

* **公交卡 (IC卡芯片):** 存储余额和安全信息的芯片。
* **读卡器:** 安装在公交车或地铁站的刷卡设备。
* **后台系统:** 公交系统的中央服务器，用于交易记录、结算等。

**动作流:**

1.  **卡片靠近读卡器:**
    * **动作:** 用户将公交卡靠近读卡器的感应区域。
    * **结果:** 读卡器和公交卡芯片通过NFC等非接触式技术建立无线连接。

2.  **读卡器读取卡片唯一标识符:**
    * **动作:** 读卡器发送指令读取公交卡芯片的唯一序列号 (UID/CSN)。
    * **结果:** 读卡器获取卡片的身份标识。

3.  **相互认证 (可选但常见):**
    * **读卡器发起认证:**
        * **动作:** 读卡器生成一个随机数并发送给公交卡芯片。
    * **卡片响应认证:**
        * **动作:** 公交卡芯片使用内部密钥和加密算法（如DES/3DES/AES/SM7）对接收到的随机数进行加密或处理。
        * **结果:** 卡片将处理后的结果返回给读卡器。
    * **读卡器验证响应:**
        * **动作:** 读卡器使用预存或后台获取的相应密钥验证卡片返回的结果是否正确。
        * **结果:** 验证成功则认为卡片合法。
    * **(反向认证 - 可选):** 卡片也可能对读卡器进行类似的认证过程。

4.  **读卡器发送扣费请求:**
    * **动作:** 读卡器构建包含交易金额等信息的扣费请求报文。
    * **安全处理:**
        * **动作:** 读卡器可能使用会话密钥（若已协商）加密交易数据。
        * **动作:** 读卡器可能计算交易数据的消息认证码 (MAC) 或生成数字签名。
    * **结果:** 安全的扣费请求报文发送给公交卡芯片。

5.  **卡片内部处理:**
    * **接收请求:**
        * **动作:** 公交卡芯片接收到扣费请求报文。
        * **安全处理:**
            * **动作:** 若报文已加密，卡片使用相应密钥解密。
            * **动作:** 卡片验证报文中的MAC或数字签名，确保数据完整性。
    * **余额检查:**
        * **动作:** 卡片检查电子钱包余额是否大于或等于扣费金额。
    * **扣费操作 (若余额充足):**
        * **动作:** 卡片更新内部存储的余额，减去扣费金额。
    * **记录交易 (可选):**
        * **动作:** 卡片可能在内部存储器中记录本次交易信息。
    * **生成响应:**
        * **动作:** 卡片构建包含交易结果（成功/失败、扣费金额、新余额等）的响应报文。
        * **安全处理:**
            * **动作:** 卡片可能使用会话密钥加密响应数据。
            * **动作:** 卡片可能计算响应数据的MAC或生成数字签名。
    * **结果:** 安全的交易响应报文发送回读卡器。

6.  **读卡器接收并验证响应:**
    * **动作:** 读卡器接收到公交卡芯片的响应报文。
    * **安全处理:**
        * **动作:** 若报文已加密，读卡器使用相应密钥解密。
        * **动作:** 读卡器验证报文中的MAC或数字签名。
    * **结果确认:**
        * **动作:** 读卡器根据响应报文判断交易是否成功。
        * **结果:** 读卡器发出交易成功或失败的提示（例如，蜂鸣声、屏幕显示）。

7.  **后台系统处理 (异步):**
    * **数据上传:**
        * **动作:** 读卡器将交易记录（包括卡号、交易时间、金额等）上传到后台系统。
    * **数据验证与结算:**
        * **动作:** 后台系统对上传的交易数据进行验证、核对和结算。
        * **结果:** 完成交易的最终记录和账户更新。