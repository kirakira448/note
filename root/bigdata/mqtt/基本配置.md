## 服务端

创建一个linux环境，运行`mosquitto`服务
以`ubuntu 22.04 LTS`版本为例

### 安装

首先需要在环境下安装`mosquitto`服务

**安装`mosquitto`服务**
```bash
sudo apt update
sudo apt install mosquitto mosquitto-clients
```

**设为开机自启动**
```bash
sudo systemctl enable mosquitto
```

**启动服务**
```bash
sudo systemctl start mosquitto
```

**查看运行状态**
```bash
sudo systemctl status mosquitto
```


### 配置

### 防火墙配置

关闭防火墙或放行1883端口
#### 关闭防火墙

```bash
sudo ufw disable
```

#### 放行1883端口

```bash
sudo ufw allow 1883/tcp
```


### `mosquitto`配置

#### 修改配置文件
Mosquitto 配置文件 `/etc/mosquitto/mosquitto.conf`
```bash
sudo nano /etc/mosquitto/mosquitto.conf
```

完整配置如下
```bash
# Place your local configuration in /etc/mosquitto/conf.d/
#
# A full description of the configuration file is at
# /usr/share/doc/mosquitto/examples/mosquitto.conf.example

pid_file /run/mosquitto/mosquitto.pid

persistence true
persistence_location /var/lib/mosquitto/

log_dest file /var/log/mosquitto/mosquitto.log

include_dir /etc/mosquitto/conf.d

listener 1883 0.0.0.0  # 新增

# allow_anonymous true  # 是否启用匿名连接
password_file /etc/mosquitto/passwd   # 用户账号密码保存文件的位置
```


#### 生成 Mosquitto 用户名和密码

```bash
sudo mosquitto_passwd -c /etc/mosquitto/passwd your_username
```
根据提示输入密码

#### 重启服务

```bash
sudo systemctl restart mosquitto
```


#### 重启失败的情况

我在使用root权限创建passwd文件时，出现了无法重启的情况，排查后原因为：
- mosquitto没有读取passwd文件的权限

解决方法如下：
##### 1. 查看passwd文件权限
```bash
ls -l /etc/mosquitto/passwd
```
我当前的权限如下
```bash
root@hoso-sdvod-002:~# ls -l /etc/mosquitto/passwd
-rw------- 1 root root 118 Oct  3 14:13 /etc/mosquitto/passwd
```

##### 2. 更改文件所有者
将文件的所有者更改为 mosquitto 用户。
```bash
sudo chown mosquitto:mosquitto /etc/mosquitto/passwd
```

##### 3. 更改文件权限
确保文件权限允许 mosquitto 用户读取。
```bash
sudo chmod 640 /etc/mosquitto/passwd
```


##### 4. 检查更新后的权限
```bash
ls -l /etc/mosquitto/passwd
```

当前权限如下：
```bash
root@hoso-sdvod-002:~# ls -l /etc/mosquitto/passwd
-rw-r----- 1 mosquitto mosquitto 118 Oct  3 14:13 /etc/mosquitto/passwd
```

##### 5. 重启服务
```bash
systemctl restart mosquitto
```

## 客户端

使用python做测试
需要分别写publisher和subscriber

安装依赖
```bash
pip install paho-mqtt
```

### `publisher.py`

用于向topic发送信息

```python
import random
import time
import paho.mqtt.client as mqtt

broker = '10.177.1.164'  # 目标ip
port = 1883  # 端口
topic = "python/mqtt"  # 主题
client_id = f'publish-{random.randint(0, 1000)}'
username='kang' # 使用的mqtt用户
password='123456' # 用户密码
client = mqtt.Client(client_id=client_id)
client.username_pw_set(username=username,password=password) # 使用这个用户

def on_connect(client, userdata, flags, rc):
    if rc == 0:
        print("Connected successfully")
    else:
        print(f"Connection failed with code {rc}")

client.on_connect = on_connect        
try:
    client.connect(broker, port, 60)
    client.loop_start()  # 开始网络循环
except ConnectionRefusedError as e:
    print(f"Connection failed: {e}")
except Exception as e:
    print(f"An unexpected error occurred: {e}")

# 用于发布消息的方法
def publish(client):
    msg_count = 0
    while True:
        time.sleep(1)
        msg = f"messages: {msg_count}" # 发布的消息
        result = client.publish(topic, msg) # 发布
        status = result[0]
        if status == 0:
            print(f"Send `{msg}` to topic `{topic}`")
        else:
            print(f"Failed to send message to topic {topic}")
        msg_count += 1


try:
    while True:
        publish(client)
except KeyboardInterrupt:
    client.loop_stop()
    client.disconnect()
```


### `subscriber.py`

接收topic的信息

```python
# python3.6
import random
from paho.mqtt import client as mqtt_client

broker = '10.177.1.164'  # 目标ip
port = 1883  # 端口
topic = "python/mqtt"  # 主题
client_id = f'subscribe-{random.randint(0, 100)}'
username='kang' # 使用的mqtt用户
password='123456' # 用户密码
client = mqtt.Client(client_id=client_id)
client.username_pw_set(username=username,password=password) # 使用这个用户

def connect_mqtt() -> mqtt_client:
    def on_connect(client, userdata, flags, rc):
        if rc == 0:
            print("Connected to MQTT Broker!")
        else:
            print("Failed to connect, return code %d\n", rc)

    client = mqtt_client.Client(client_id=client_id)
    client.on_connect = on_connect
    client.connect(broker, port)
    return client

# 订阅消息的方法
def subscribe(client: mqtt_client):
    def on_message(client, userdata, msg):
        print(f"Received `{msg.payload.decode()}` from `{msg.topic}` topic")

    client.subscribe(topic) # 订阅目标主题
    client.on_message = on_message

def run():
    client = connect_mqtt()
    subscribe(client)
    client.loop_forever()

if __name__ == '__main__':
    run()

```

